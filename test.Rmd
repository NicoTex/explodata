---
title: "explodata"
author: "Texier-Dauby"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load-packages}

library(tidyverse)
library(rdrop2)
library(knitr)
library(ggrepel)

```

```{r dropbox-init}

drop_auth()
token <- drop_auth()
saveRDS(token, file = "token.rds")

```

```{r download-data-dropbox, eval=FALSE, echo=FALSE}
drop_download("gilles_nico_tex/Selection_specimen_GAB_end_19022019.csv", overwrite = TRUE)
drop_download("gilles_nico_tex/Gabon_Endemics_species_19022019.csv", overwrite = TRUE)
drop_download("gilles_nico_tex/Gabon_full_2018.csv", overwrite = TRUE)
```

```{r dropbox_load, include=FALSE}

#### Load dataset from dropbox

# dataset <- 
#   drop_read_csv("gilles_nico_tex/EOO.results.csv") %>% 
#   as_tibble()


### Data specimen (tous les sp√©cimens des esp√®ces end√©miques du Gabon)

dataset <- 
  read_csv("Selection_specimen_GAB_end_19022019.csv", col_types = 
              list(IDGBIF = col_double(),
                   SameAs = col_character(),
                   LatitudeDecimal = col_double(),
                   LongitudeDecimal = col_double(),
                   AccuracyGBIF = col_character(),
                   AccuracyDroissart = col_double(),
                   Accuracy = col_double(),
                   Kept_analysis = col_character(),
                   Updated_data_Trop = col_character(),
                   LowerName = col_character(),
                   `Maximum Day` = col_double(),
                   `Maximum Month` = col_double(),
                   `Maximum Year` = col_double(),
                   `Ecological Habitat` = col_character(),
                   `Ecological Substrate` = col_character(),
                   `Ecological Seasonality` = col_character(),
                   `Ecological Site` = col_character(),
                   ChildHerbNb = col_character(),
                   `Uploaded Trop` = col_character(),
                   DeterminationYear = col_character()
                   ))

## field with problems in importation
problems(dataset) %>%
  distinct(col)

problems(dataset) %>%
  filter(col=="MinimumElevation") %>%
  distinct(actual)

problems(dataset) %>%
  filter(col=="DeterminationYear")



### Data species (metadata sur les esp√®ces end√©miques du Gabon)

species <- 
  read_csv("Gabon_Endemics_species_19022019.csv")

problems(species) %>%
  distinct(col)


### Data full Gabon (tous les sp√©cimens du Gabon)
full_gabon <- 
  read_csv("Gabon_full_2018.csv", col_types = 
              list(ddlat = col_double(),
                   ddlon = col_double(),
                   nbr = col_character()
                   ))

problems(full_gabon) %>%
 distinct(col)
```



```{r extreme_coord, eval=FALSE, include=FALSE}

#### Check extreme coordinates

check <- select(dataset, ID, LatitudeDecimal, LongitudeDecimal)
arrange(check, LatitudeDecimal)
arrange(check, desc(LatitudeDecimal))
arrange(check, LongitudeDecimal)
arrange(check, desc(LongitudeDecimal))


## Find a row with specific value

# which(grepl(166987, data$ID)) # quelle ligne a l'ID=166987
# data <- data[!(data$ID=="166987"),] # enlever une certaine ligne selon sa valeur dans une variable/colonne

```


# Gabonese plant endemism analyse
```{r species table, echo= FALSE}

## Endemic species with specimen list
end_esp_anal <- species %>%
  filter (END_BDDEndemix==1 | END_BDDEndemix==9) # select strict (1) and likely (9) endemic species data with verified specimen list


# prÈvoir d'enlever les ined ! + de mettre les noms updatÈs (Name New) #


#### Strict and likely endemic species

end_esp_all <- species %>%
  filter (END_BDDEndemix==1 | END_BDDEndemix==9 | (END_checklist==1 & END_BDDEndemix==2)) %>%
  mutate ("Endemism status"= if_else(END_BDDEndemix==1, 1, if_else(END_BDDEndemix==9, 2, 3))) %>% 
  select ("Endemism status", FAMILY, SPECIES, UICN_cat_final) %>%
  rename ("IUCN cat" = UICN_cat_final) %>% 
  arrange (FAMILY, SPECIES)

# Table
options(knitr.kable.NA = '')
kable(end_esp_all, caption = "Table 1: Endemic species of Gabon with preliminary conservation status. Endemism status: 1.Strict endemic; 2.Likely endemic; 3.Checklist endemic")

  
  
```


Plot 1 : Nombre de spÈcimen d'herbiers par espËce endÈmique
```{r nb_specimens, echo=FALSE}

#### Specimen number by species

nb_occ_tot <- dataset %>% 
  count (NameNoAuthors) %>%  # compte le nombre de specimens par espece
  rename(Tot = n) # renomme la colonne "n" en "Tot"

# Avec condition
nb_occ_crit <- dataset %>% 
  filter (grepl("Klaine", CollectorString)) %>% # lignes qui ont comme collecteur "Klaine"
  count (NameNoAuthors) %>%  # nb de specimen par espece avec cette condition
  rename("Klaine" = n)

result_crit <- inner_join (nb_occ_tot, nb_occ_crit, by="NameNoAuthors")


## Plot nb especes en fonction nb de specimens
# Choix des limites de regroupement (nb de sp√©cimens)
nb_gp <- nb_occ_tot %>% summarise (g1=sum(Tot==1), g2=sum(Tot>=2 & Tot<=5), g3=sum(Tot>5 & Tot<=10), g4=sum(Tot>10 & Tot<=30), g5=sum(Tot>30))
gp <- tibble(Nb_spec=c("1","2-5","6-10","10-30",">30"),Nb_esp=unlist(c(nb_gp[,1:5])))
gp <- gp %>% 
  mutate(Perc= round(Nb_esp/sum(Nb_esp)*100,1))

# Plot
gp$Nb_spec <- factor (gp$Nb_spec, levels=c("1","2-5","6-10","10-30",">30")) # obliger de mettre cette donnee en facteur pour que ggplot prenne en compte cet ordre de donnees pour ploter
ggplot(data=gp,aes(x=Nb_spec,y=Nb_esp)) + geom_bar(stat="identity") + geom_text(aes(label=paste(Perc,"%",sep=" ")),vjust=1.6,color="white") + xlab("Number of specimens") + ylab("Number of species")

```



```{r habitus_RB, eval=FALSE, include=FALSE}

#### Species habitus according to Rainbio data

habit_RB<-dataset %>% 
  filter (!is.na(`Ecological LifeForm`)) %>% 
  group_by(NameNoAuthors) %>%
  distinct(`Ecological LifeForm`)

nb_habit_RB <- habit_RB %>% 
  group_by(NameNoAuthors) %>%
  summarise(n = n_distinct(`Ecological LifeForm`))

habit_unique <- nb_habit_RB %>% 
  filter (n == 1) # to select data that have only one type of habitus in Rainbio data

Habitus <- habit_RB [habit_RB$NameNoAuthors %in% habit_unique$NameNoAuthors,]

# write.csv(Habitus,"C:/Users/Administrateur/Desktop/Habitus_species_RB.csv")
```


Plot 2 : Proportion des habitus chez espËces endÈmiques
```{r habitus_stat, echo = FALSE}

# From dataset "species", from endemic species

#### Proportion of different habitus in the dataset for endemics

habit_prop <- end_esp_anal %>% 
  count (`Habitus 1`) %>% # nb of each habitus
  mutate(prop= round(n/sum(n)*100,1))  # % of each habitus


ggplot (data=habit_prop, aes(x=reorder(`Habitus 1`,prop), y=prop)) + geom_bar(stat="identity") + coord_flip() + geom_text(aes(label=paste(prop,"%",sep=" ")), vjust=0.5, hjust=1.2, color="white") + xlab("Habitus") + ylab("Proportion (%)") # reorder allows to sort by a numeric variable


## Representation in a pie chart
#theme_pie <- theme(panel.background = element_blank(), axis.title = element_blank(), axis.text = element_blank())

#ggplot (data=habit_prop, aes(x="", y=prop,  fill=`Habitus 1`)) + geom_bar(stat="identity") + coord_polar(theta = "y") + geom_label_repel(aes(label = prop), size=5, show.legend = F, nudge_x = 1) + guides(fill = guide_legend(title = "Group")) + theme_pie

```


Plot 3: Proportion des familles chez espËces endÈmiques
Plot 4: Famille ayant le plus de % d'espËces endÈmique (avec nombre d'espËce endÈmique indiquÈ)
Plot 5: Genres les plus reprÈsentÈs chez espËces endÈmiques
```{r taxo_stat, echo = FALSE}

#### Most representative taxon within endemics and proportion within Gabonese flora

## Family

end_fam_nb <- end_esp_anal %>% # calculate nb of species per family within endemics
  count (FAMILY) %>% 
  mutate (n = as.numeric (n)) %>% 
  arrange(-n) # sort by decreasing order


full_gab_fam_nb <- full_gabon %>% # calculate nb of species per family within Gabonese flora
  filter (tax_esp != "###") %>% # remove specimens not identified at species level
  distinct (tax_tax, tax_fam) %>%  # all taxa with associated family
  count (tax_fam) %>% # count for number of taxon in each family
  mutate (n = as.numeric (n)) %>%
  arrange(-n) %>% 
  rename("FAMILY" = tax_fam)


end_fam_prop <- left_join(end_fam_nb, full_gab_fam_nb, by= "FAMILY") %>%  # calculate proportion of endemic species within each family in Gabon
  rename ("n_end" = n.x) %>% 
  rename ("n_gab" = n.y) %>% 
  mutate (prop = round(n_end/n_gab*100,1)) %>% 
  arrange (-prop)


# Plot - Most represented families in endemics

X = 10 # Treshold of species number for a family to be represented in the graph

fam_low <- end_fam_nb %>% # Calculate nb of families with less than X species
  filter (n<X) %>%
  summarise ("n" = sum(n)) %>%
  add_column("FAMILY" = "Others families") %>% 
  select (FAMILY,everything()) # order column
  
end_fam <- end_fam_nb %>% # Recap tible with families more than X species
  filter (n>X) %>% 
  rbind(fam_low) %>% 
  mutate (prop=round(n/sum(n)*100,1))

ggplot(data=end_fam, aes(x=reorder(FAMILY,-`n`), y=`n`)) + geom_bar(stat="identity") + xlab("Families") + ylab("Species number") + geom_text(aes(label=paste(prop,"%",sep=" ")), vjust=1.6, color="white") + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.3))


# Plot - Most represented families in endemics compare to Gabonese flora

X = 20 # The top X families with most proportion of endemic will be dispayed
ggplot(data=end_fam_prop %>% top_n(X), aes(x=reorder(FAMILY,-prop), y=prop)) + geom_bar(stat="identity") + xlab("Families") + ylab("Proportion") + geom_text(aes(label=n_end), vjust=1.6, color="white") + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.3))



## Genus

end_gen_nb <- end_esp_anal %>% 
  count (GENUS) %>%
  mutate (n = as.numeric (n)) %>%
  arrange(-n)


full_gab_gen_nb <- full_gabon %>%
  filter (tax_esp != "###") %>% # remove specimens not identified at species level
  distinct (tax_tax, tax_gen) %>%  # all taxa with associated family
  count (tax_gen) %>% # count for number of taxon in each family
  mutate (n = as.numeric (n)) %>%
  arrange(-n) %>% 
  rename("GENUS" = tax_gen)


end_gen_prop <- left_join(end_gen_nb, full_gab_gen_nb, by= "GENUS") %>%  # add result of full_gab in result of endemic
  rename ("n_end" = n.x) %>% 
  rename ("n_gab" = n.y) %>% 
  mutate (prop = round(n_end/n_gab*100,1)) %>% 
  arrange (-prop)


# Plot - Most represented genera in endemics

X = 10 # The top X most represented genera (in terms of species number) in endemics

gen_low <- end_gen_nb %>% # Calculate nb of families with less than X species
  top_n(-X) %>%
  summarise ("n" = sum(n)) %>%
  add_column("GENUS" = "Others genera") %>% 
  select (GENUS,everything()) # order column
  
end_gen <- end_gen_nb %>% # Recap tible with families more than X species
  top_n(X) %>% 
  rbind(gen_low) %>% 
  mutate (prop=round(n/sum(n)*100,1))


ggplot(data=end_gen, aes(x=reorder(GENUS,-n), y=n)) + geom_bar(stat="identity") + xlab("Genera") + ylab("Species number") + geom_text(aes(label=paste(round(n/sum(n)*100,1),"%",sep=" ")), vjust=1.6, color="white") + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=0.3))


```


Plot 6: Proportion des catÈgories UICN chez espËces endÈmiques
Plot 7: Proportion des habitus dans catÈgories UICN des espËces endÈmiques
```{r threatened stat, echo = FALSE}

#### IUCN categories

IUCN_cat_prop <- end_esp_anal %>% 
  count (UICN_cat_final) %>% # nb of each habitus
  mutate(prop= round(n/sum(n)*100,1)) %>% 
  rename ("IUCN_cat" = UICN_cat_final)

IUCN_cat_prop$IUCN_cat <- factor (IUCN_cat_prop$IUCN_cat, levels=c("EX","CR","EN","VU","NT","LC","DD")) # obliger de mettre cette donnee en facteur pour que ggplot prenne en compte cet ordre de donnees pour ploter
ggplot(data=IUCN_cat_prop, aes(x=IUCN_cat, y=`n`)) + geom_bar(stat="identity") + xlab("IUCN categries") + ylab("Species number") + geom_text(aes(label=paste(prop,"%",sep=" ")), vjust=1.6, color="white") + geom_vline(xintercept=4.5, linetype="dashed", size= 1)



#### IUCN categories + habitus

# source("D:/WORK/THESIS/RAINBIO_exploration/explodata/Function_label_position_fill.R")

ggplot(data=end_esp_anal, aes(x= factor(UICN_cat_final, levels=c("EX","CR","EN","VU","NT","LC","DD")), fill=`Habitus 1`)) + geom_bar(stat="count") + xlab("IUCN categries") + ylab("Species number") + geom_vline(xintercept=4.5, linetype="dashed", size= 1) + guides(fill=guide_legend(title="Habitus"))
#stat_fill_labels(position = position_stack(vjust = 50))

```


